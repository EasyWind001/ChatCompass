# ChatCompass v1.2.2 开发计划

## 📅 版本信息
- **版本号**: v1.2.2
- **开发周期**: 预计2-3周
- **发布类型**: Minor Release（功能增强）
- **当前状态**: 📋 规划中

---

## 🎯 核心目标

### 1. 数据库升级：SQLite → Elasticsearch
**目标**: 提升存储和搜索性能，支持更大规模数据

**改进点**:
- ✅ 分布式存储，支持海量数据
- ✅ 更强大的全文搜索能力
- ✅ 更快的查询响应速度
- ✅ 支持复杂的聚合查询
- ✅ 更好的中文分词支持

### 2. Docker容器化部署
**目标**: 一键启动完整环境，降低使用门槛

**包含组件**:
- ✅ Elasticsearch（数据库）
- ✅ Ollama（本地AI服务）
- ✅ ChatCompass应用
- ✅ 轻量级AI模型（Qwen2.5:3B）

---

## 🏗️ 技术架构调整

### 当前架构 (v1.2.0)
```
ChatCompass App
    ├── SQLite (本地数据库)
    ├── OpenAI API (可选，需要密钥)
    └── Ollama (可选，需要手动安装)
```

### 新架构 (v1.2.2)
```
Docker Compose
    ├── Elasticsearch (7.17.x)
    │   └── Port: 9200
    ├── Ollama (latest)
    │   ├── Port: 11434
    │   └── Model: qwen2.5:3b (3GB模型)
    └── ChatCompass App
        └── Port: 8000 (Web UI, 可选)
```

---

## 📋 任务分解

### Phase 1: Elasticsearch集成 (Feature 1)
**分支**: `feature/elasticsearch-integration`

#### 1.1 数据库抽象层
- [ ] 创建 `database/base_storage.py` - 存储接口抽象
- [ ] 保持 `database/db_manager.py` 兼容（SQLite实现）
- [ ] 创建 `database/es_manager.py` - Elasticsearch实现

#### 1.2 Elasticsearch实现
- [ ] 索引设计（conversations, messages）
- [ ] 中文分词配置（IK Analyzer）
- [ ] 全文搜索优化
- [ ] 数据迁移工具（SQLite → ES）

#### 1.3 配置和依赖
- [ ] 更新 `requirements.txt`（添加elasticsearch库）
- [ ] 更新 `config.py`（添加ES配置）
- [ ] 环境变量配置（.env.example）

#### 1.4 测试
- [ ] 单元测试（`tests/unit/test_es_manager.py`）
- [ ] 集成测试（`tests/integration/test_es_search.py`）
- [ ] 性能测试（对比SQLite和ES）
- [ ] 数据迁移测试

**预计时间**: 5-7天

---

### Phase 2: Docker容器化 (Feature 2)
**分支**: `feature/docker-deployment`

#### 2.1 Docker配置
- [ ] 创建 `Dockerfile` - ChatCompass应用镜像
- [ ] 创建 `docker-compose.yml` - 多容器编排
- [ ] 创建 `.dockerignore` - 忽略规则

#### 2.2 服务配置
- [ ] Elasticsearch容器配置
  - 内存限制（2GB）
  - 持久化存储
  - 中文分词插件
- [ ] Ollama容器配置
  - 模型下载脚本
  - GPU支持（可选）
- [ ] ChatCompass容器配置
  - 依赖安装
  - 启动脚本

#### 2.3 初始化脚本
- [ ] `docker/init-es.sh` - ES初始化
- [ ] `docker/init-ollama.sh` - Ollama模型下载
- [ ] `docker/healthcheck.sh` - 健康检查

#### 2.4 文档
- [ ] `docs/DOCKER_GUIDE.md` - Docker使用指南
- [ ] 更新 `README.md` - 添加Docker启动方式
- [ ] 创建快速启动脚本（`docker-start.bat/sh`）

**预计时间**: 3-4天

---

### Phase 3: AI模型优化 (Feature 3)
**分支**: `feature/ollama-optimization`

#### 3.1 模型选择和配置
- [ ] 选择轻量级模型：**Qwen2.5:3B**
  - 模型大小：~3GB
  - 内存占用：~4GB
  - 支持中英文
  - 擅长摘要和分类
- [ ] 备选模型：
  - Llama3.2:3B
  - Gemma2:2B
  - Phi3:3.8B

#### 3.2 Ollama客户端优化
- [ ] 更新 `ai/ollama_client.py`
  - 自动检测Ollama服务
  - 配置化模型选择
  - 错误处理优化
- [ ] 提示词优化
  - 摘要生成提示词
  - 标签提取提示词
  - 分类提示词

#### 3.3 测试
- [ ] 模型性能测试
- [ ] 摘要质量测试
- [ ] 响应速度测试

**预计时间**: 2-3天

---

### Phase 4: 兼容性和迁移 (Feature 4)
**分支**: `feature/backward-compatibility`

#### 4.1 向后兼容
- [ ] 保持SQLite支持（配置项控制）
- [ ] 配置文件版本检测
- [ ] 平滑升级路径

#### 4.2 数据迁移工具
- [ ] `tools/migrate_to_es.py` - 迁移脚本
- [ ] 迁移进度显示
- [ ] 回滚功能

#### 4.3 配置管理
- [ ] `config.py` 增强
  - 多存储后端支持
  - Docker环境检测
  - 自动配置

**预计时间**: 2天

---

## 📦 技术选型

### Elasticsearch配置
```yaml
version: 7.17.x (稳定版)
plugins:
  - analysis-ik (中文分词)
memory: 2GB
storage: 10GB (可扩展)
```

### Ollama模型
```yaml
model: qwen2.5:3b
size: ~3GB
memory: ~4GB RAM
languages: 中文, English
tasks:
  - 对话摘要
  - 标签提取
  - 内容分类
```

**选择理由**:
- ✅ 模型小巧（3GB），适合个人使用
- ✅ 中文能力强（阿里巴巴开发）
- ✅ 推理速度快
- ✅ 内存占用合理（4-6GB）
- ✅ 开源免费

### 备选模型对比

| 模型 | 大小 | 内存 | 中文 | 摘要能力 | 推荐度 |
|------|------|------|------|----------|--------|
| **Qwen2.5:3B** | 3GB | 4GB | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ✅ 首选 |
| Llama3.2:3B | 3GB | 4GB | ⭐⭐⭐ | ⭐⭐⭐⭐ | 备选 |
| Gemma2:2B | 2GB | 3GB | ⭐⭐⭐ | ⭐⭐⭐ | 轻量 |
| Phi3:3.8B | 3.8GB | 5GB | ⭐⭐⭐ | ⭐⭐⭐⭐ | 备选 |

---

## 📂 文件结构变化

### 新增文件
```
ChatCompass/
├── Dockerfile                          # 应用镜像
├── docker-compose.yml                  # 容器编排
├── .dockerignore                       # Docker忽略规则
├── docker-start.bat                    # Windows快速启动
├── docker-start.sh                     # Linux/Mac快速启动
├── database/
│   ├── base_storage.py                # 存储接口抽象
│   ├── es_manager.py                  # ES实现
│   └── db_manager.py                  # SQLite实现（保留）
├── docker/
│   ├── init-es.sh                     # ES初始化
│   ├── init-ollama.sh                 # Ollama初始化
│   └── healthcheck.sh                 # 健康检查
├── tools/
│   └── migrate_to_es.py               # 数据迁移工具
└── docs/
    ├── DOCKER_GUIDE.md                # Docker指南
    ├── ELASTICSEARCH_SETUP.md         # ES配置说明
    └── V1.2.2_PLAN.md                 # 本文档
```

### 修改文件
```
- config.py                             # 添加ES和Docker配置
- requirements.txt                      # 添加elasticsearch依赖
- .env.example                          # 添加ES环境变量
- README.md                             # 添加Docker启动说明
- main.py                               # 支持多存储后端
```

---

## 🔧 依赖更新

### requirements.txt 新增
```txt
# Elasticsearch
elasticsearch==7.17.9
elasticsearch-dsl==7.4.0

# Docker支持
docker==7.0.0

# 性能监控
psutil==5.9.5
```

### Docker镜像
```yaml
elasticsearch:7.17.9
ollama/ollama:latest
python:3.9-slim
```

---

## 🧪 测试计划

### 单元测试
- [ ] `test_es_manager.py` - ES管理器测试
- [ ] `test_base_storage.py` - 接口测试
- [ ] `test_migration.py` - 数据迁移测试

### 集成测试
- [ ] `test_docker_compose.py` - 容器编排测试
- [ ] `test_es_search.py` - ES搜索测试
- [ ] `test_ollama_integration.py` - Ollama集成测试

### 性能测试
- [ ] 插入性能（SQLite vs ES）
- [ ] 搜索性能（FTS5 vs ES）
- [ ] 内存占用测试
- [ ] 并发性能测试

### 兼容性测试
- [ ] Windows 10/11
- [ ] Ubuntu 20.04/22.04
- [ ] macOS 12+
- [ ] Docker Desktop
- [ ] Docker Engine

---

## 📝 文档更新

### 新增文档
- [ ] `docs/DOCKER_GUIDE.md` - Docker完整指南
- [ ] `docs/ELASTICSEARCH_SETUP.md` - ES配置说明
- [ ] `docs/MIGRATION_GUIDE.md` - 从v1.2.0迁移指南
- [ ] `docs/PERFORMANCE_COMPARISON.md` - 性能对比报告

### 更新文档
- [ ] `README.md` - 添加Docker快速启动
- [ ] `README_CN.md` - 中文版本同步
- [ ] `CHANGELOG.md` - v1.2.2变更记录
- [ ] `CONTRIBUTING.md` - Docker开发环境说明

---

## 🚀 发布计划

### Release Timeline
```
Week 1: Phase 1 + Phase 2 (ES + Docker基础)
Week 2: Phase 3 + Phase 4 (AI优化 + 兼容性)
Week 3: 测试 + 文档 + 发布准备
```

### 发布流程
```bash
# 1. 合并所有feature分支到develop
feature/elasticsearch-integration → develop
feature/docker-deployment → develop
feature/ollama-optimization → develop
feature/backward-compatibility → develop

# 2. 创建release分支
git checkout -b release/v1.2.2

# 3. 版本号更新
# 修改 setup.py, __version__ 等

# 4. 更新CHANGELOG
# 添加v1.2.2所有变更

# 5. 测试
python -m pytest tests/ -v
docker-compose up --build

# 6. 合并到main
release/v1.2.2 → main

# 7. 打标签
git tag -a v1.2.2 -m "Release v1.2.2"

# 8. 合并回develop
release/v1.2.2 → develop
```

---

## ⚠️ 风险和挑战

### 技术风险
1. **ES性能调优**
   - 风险: 默认配置可能不适合个人使用
   - 缓解: 提供预优化配置，限制内存使用

2. **Docker资源占用**
   - 风险: ES + Ollama + App 总内存需求 ~8GB
   - 缓解: 提供资源配置建议，支持单独启动

3. **数据迁移兼容性**
   - 风险: SQLite数据可能无法完整迁移
   - 缓解: 详细测试，提供验证工具

### 用户体验风险
1. **首次启动时间长**
   - 风险: 下载镜像和模型需要时间
   - 缓解: 提供进度显示，分步启动选项

2. **学习曲线**
   - 风险: Docker新用户可能不熟悉
   - 缓解: 详细的图文教程，一键启动脚本

---

## ✅ Definition of Done

### 功能完成标准
- [ ] 所有Phase任务完成
- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试全部通过
- [ ] 性能满足预期（搜索 < 100ms）
- [ ] Docker一键启动成功
- [ ] 文档完整且准确

### 代码质量标准
- [ ] 遵循项目代码规范
- [ ] 所有Commit符合规范
- [ ] 代码审查通过
- [ ] 无严重Bug
- [ ] 向后兼容v1.2.0

### 发布标准
- [ ] 在3个系统上测试通过（Win/Linux/Mac）
- [ ] Docker Hub镜像发布
- [ ] GitHub Release创建
- [ ] 用户文档发布
- [ ] 迁移指南完成

---

## 📊 成功指标

### 性能指标
- 搜索速度提升: > 3x
- 支持数据量: > 10万条对话
- 内存占用: < 8GB
- 启动时间: < 2分钟

### 用户体验指标
- Docker启动成功率: > 95%
- 迁移成功率: > 99%
- 文档满意度: > 4.5/5
- Bug报告: < 5个严重Bug

---

## 📞 联系和支持

- **开发分支**: `develop`
- **Release分支**: `release/v1.2.2`（待创建）
- **Issue跟踪**: GitHub Issues
- **讨论**: GitHub Discussions

---

**计划创建时间**: 2026-01-13  
**最后更新**: 2026-01-13  
**状态**: 📋 待开始
