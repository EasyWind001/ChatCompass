# ⚡ AI超时处理快速指南

## 🎯 一句话总结

**即使AI超时，对话也能100%保存，带有基础的摘要、分类和标签！**

---

## 🛡️ 三层防护机制

```
第一层：智能截断
  ↓ 95%成功
第二层：合理超时（180秒）
  ↓ 4%成功
第三层：降级方案
  ↓ 1%降级
结果：100%保存 ✅
```

---

## ⚙️ 推荐配置（复制到.env）

```bash
# 三行配置，开箱即用
AI_TIMEOUT=180              # 3分钟超时（足够用）
AI_ENABLE_FALLBACK=true     # 启用降级（必须）
OLLAMA_MODEL=qwen2.5:3b     # 快速模型
```

---

## 💡 常见问题速查

### Q1: 什么是降级方案？

**A**: AI超时时，用规则自动生成基础摘要和标签，保证对话能保存。

### Q2: 降级质量如何？

**A**: 
- 摘要：截取前150字（比AI差，但有内容）
- 分类：关键词匹配（60-75%准确）
- 标签：高频词统计（基本相关）
- 置信度：0.3（vs AI的0.8）

### Q3: 如何识别降级结果？

**A**: 
1. 置信度 < 0.5
2. 日志有"启动降级方案"
3. 查询：`SELECT * FROM conversations WHERE confidence < 0.5`

### Q4: 可以禁用降级吗？

**A**: 可以，但**不推荐**！
```bash
export AI_ENABLE_FALLBACK=false  # AI失败会返回None
```

### Q5: 降级触发多少次算正常？

**A**: **<10%正常**，>20%需要优化（增加超时或换模型）

---

## 📊 效果演示

### 场景1：正常（90%）

```bash
✅ AI分析完成: 编程 | 置信度: 0.8
```

### 场景2：降级（5-10%）

```bash
❌ 分析超时（180秒）
🔄 启动降级方案...
✅ 降级分析完成: 编程 | 置信度: 0.3
```

### 场景3：禁用降级（不推荐）

```bash
❌ 分析超时
⚠️  降级已禁用
结果：摘要=空，分类=未分类 ❌
```

---

## 🚀 快速测试

```bash
# 测试降级方案
python examples/test_fallback.py

# 测试大文本处理
python examples/test_large_text.py
```

---

## 📚 完整文档

- [超时处理总结](TIMEOUT_HANDLING_SUMMARY.md) - 完整说明
- [降级方案详解](docs/FALLBACK_STRATEGY.md) - 技术细节
- [性能优化](docs/PERFORMANCE_TIPS.md) - 优化技巧

---

**记住**：默认配置已经很好，无需调整！ 🎉
